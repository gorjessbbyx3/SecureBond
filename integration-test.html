<!DOCTYPE html>
<html>
<head>
    <title>SecureBond Integration Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .pass { color: green; }
        .fail { color: red; }
        .pending { color: orange; }
        button { margin: 5px; padding: 8px 16px; }
        .results { background: #f5f5f5; padding: 10px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>SecureBond Integration Test Suite</h1>
    
    <div class="test-section">
        <h2>Authentication Tests</h2>
        <button onclick="testAdminLogin()">Test Admin Login</button>
        <button onclick="testClientLogin()">Test Client Login</button>
        <div id="auth-results" class="results"></div>
    </div>
    
    <div class="test-section">
        <h2>Client Portal Actions</h2>
        <button onclick="testClientCheckIn()">Test Check-In Submit</button>
        <button onclick="testClientPayment()">Test Payment Upload</button>
        <button onclick="testClientMessage()">Test Message Send</button>
        <div id="client-results" class="results"></div>
    </div>
    
    <div class="test-section">
        <h2>Admin Dashboard Actions</h2>
        <button onclick="testAdminViewClients()">Test View Clients</button>
        <button onclick="testAdminConfirmPayment()">Test Confirm Payment</button>
        <button onclick="testAdminAcknowledgeAlert()">Test Acknowledge Alert</button>
        <button onclick="testAdminViewAuditLogs()">Test View Audit Logs</button>
        <div id="admin-results" class="results"></div>
    </div>
    
    <div class="test-section">
        <h2>Skip Bail Prevention</h2>
        <button onclick="testSkipBailRisk()">Test Skip Bail Risk Assessment</button>
        <button onclick="testLocationPatterns()">Test Location Patterns</button>
        <button onclick="testFrequentLocations()">Test Frequent Locations</button>
        <div id="skipbail-results" class="results"></div>
    </div>
    
    <div class="test-section">
        <h2>Two-Way Data Communication</h2>
        <button onclick="testDataSync()">Test Data Synchronization</button>
        <button onclick="testRealTimeUpdates()">Test Real-Time Updates</button>
        <div id="sync-results" class="results"></div>
    </div>

    <script>
        let adminSession = null;
        let clientSession = null;
        
        async function apiCall(method, url, data = null, sessionType = 'admin') {
            const options = {
                method,
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include'
            };
            
            if (data) {
                options.body = JSON.stringify(data);
            }
            
            try {
                const response = await fetch(url, options);
                const result = await response.json();
                return { status: response.status, data: result, success: response.ok };
            } catch (error) {
                return { status: 500, error: error.message, success: false };
            }
        }
        
        function displayResult(containerId, test, result) {
            const container = document.getElementById(containerId);
            const statusClass = result.success ? 'pass' : 'fail';
            const statusText = result.success ? 'PASS' : 'FAIL';
            
            container.innerHTML += `
                <div class="${statusClass}">
                    ${statusText}: ${test} (Status: ${result.status})
                    ${result.error ? ` - Error: ${result.error}` : ''}
                </div>
            `;
        }
        
        // Authentication Tests
        async function testAdminLogin() {
            const result = await apiCall('POST', '/api/auth/admin-login', {
                username: 'admin',
                password: 'admin123',
                role: 'admin'
            });
            adminSession = result.success;
            displayResult('auth-results', 'Admin Login', result);
        }
        
        async function testClientLogin() {
            const result = await apiCall('POST', '/api/auth/client-login', {
                clientId: 'swanson.robert',
                password: 'Camputer69!'
            });
            clientSession = result.success;
            displayResult('auth-results', 'Client Login', result);
        }
        
        // Client Portal Tests
        async function testClientCheckIn() {
            const result = await apiCall('POST', '/api/check-ins', {
                clientId: 1,
                location: '21.3099,-157.8581',
                notes: 'Integration test check-in',
                biometricData: 'test_biometric',
                biometricType: 'facial',
                gpsAccuracy: 'high-precision'
            }, 'client');
            displayResult('client-results', 'Client Check-In Submit', result);
        }
        
        async function testClientPayment() {
            const result = await apiCall('POST', '/api/payments', {
                clientId: 1,
                amount: '150.00',
                paymentMethod: 'credit_card',
                notes: 'Integration test payment'
            }, 'client');
            displayResult('client-results', 'Client Payment Upload', result);
        }
        
        async function testClientMessage() {
            const result = await apiCall('POST', '/api/messages', {
                clientId: 1,
                subject: 'Test Communication',
                message: 'Testing two-way communication system'
            }, 'client');
            displayResult('client-results', 'Client Message Send', result);
        }
        
        // Admin Dashboard Tests
        async function testAdminViewClients() {
            const result = await apiCall('GET', '/api/clients');
            displayResult('admin-results', 'Admin View Clients', result);
        }
        
        async function testAdminConfirmPayment() {
            const result = await apiCall('POST', '/api/clients/1/confirm-payment/1', {
                confirmedBy: 'admin',
                notes: 'Integration test confirmation'
            });
            displayResult('admin-results', 'Admin Confirm Payment', result);
        }
        
        async function testAdminAcknowledgeAlert() {
            const result = await apiCall('POST', '/api/alerts/1/acknowledge', {
                acknowledgedBy: 'admin'
            });
            displayResult('admin-results', 'Admin Acknowledge Alert', result);
        }
        
        async function testAdminViewAuditLogs() {
            const result = await apiCall('GET', '/api/admin/audit-logs');
            displayResult('admin-results', 'Admin View Audit Logs', result);
        }
        
        // Skip Bail Prevention Tests
        async function testSkipBailRisk() {
            const result = await apiCall('GET', '/api/admin/skip-bail-risk');
            displayResult('skipbail-results', 'Skip Bail Risk Assessment', result);
        }
        
        async function testLocationPatterns() {
            const result = await apiCall('GET', '/api/admin/location/patterns?clientId=1');
            displayResult('skipbail-results', 'Location Patterns Analysis', result);
        }
        
        async function testFrequentLocations() {
            const result = await apiCall('GET', '/api/admin/location/frequent/1?days=30');
            displayResult('skipbail-results', 'Frequent Locations Tracking', result);
        }
        
        // Data Synchronization Tests
        async function testDataSync() {
            // Test that client action appears in admin dashboard
            const checkInResult = await apiCall('POST', '/api/check-ins', {
                clientId: 1,
                location: '21.3000,-157.8500',
                notes: 'Sync test check-in'
            }, 'client');
            
            // Verify it appears in admin view
            const adminViewResult = await apiCall('GET', '/api/check-ins');
            
            const success = checkInResult.success && adminViewResult.success;
            displayResult('sync-results', 'Data Synchronization Test', { 
                success, 
                status: success ? 200 : 500 
            });
        }
        
        async function testRealTimeUpdates() {
            // Test that admin actions reflect in client view
            const paymentResult = await apiCall('POST', '/api/payments', {
                clientId: 1,
                amount: '75.00',
                paymentMethod: 'cash'
            }, 'client');
            
            const confirmResult = await apiCall('POST', '/api/clients/1/confirm-payment/1', {
                confirmedBy: 'admin'
            });
            
            const success = paymentResult.success && confirmResult.success;
            displayResult('sync-results', 'Real-Time Updates Test', { 
                success, 
                status: success ? 200 : 500 
            });
        }
        
        // Run all tests
        async function runAllTests() {
            document.querySelectorAll('.results').forEach(el => el.innerHTML = '');
            
            // Authentication first
            await testAdminLogin();
            await testClientLogin();
            
            // Wait a bit for sessions to establish
            setTimeout(async () => {
                // Client tests
                await testClientCheckIn();
                await testClientPayment();
                await testClientMessage();
                
                // Admin tests
                await testAdminViewClients();
                await testAdminConfirmPayment();
                await testAdminAcknowledgeAlert();
                await testAdminViewAuditLogs();
                
                // Skip bail tests
                await testSkipBailRisk();
                await testLocationPatterns();
                await testFrequentLocations();
                
                // Sync tests
                await testDataSync();
                await testRealTimeUpdates();
            }, 1000);
        }
    </script>
    
    <div style="margin-top: 30px;">
        <button onclick="runAllTests()" style="background: #007bff; color: white; font-size: 16px; padding: 12px 24px;">
            Run All Tests
        </button>
    </div>
</body>
</html>